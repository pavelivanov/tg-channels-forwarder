# Implementation Plan: Railway Deployment

**Branch**: `018-railway-deployment` | **Date**: 2026-02-20 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/018-railway-deployment/spec.md`

## Summary

Deploy the TG Channels Forwarder to Railway PaaS. Create a single Railway project with 4 services: API (web), Worker (background), PostgreSQL (managed), and Redis (managed). Add `railway.toml` config files for each app service, adjust Dockerfiles for Railway compatibility (Prisma migrations in pre-deploy, correct port handling), and provide setup documentation.

## Technical Context

**Language/Version**: TypeScript 5.x, Node.js 22 (existing)
**Primary Dependencies**: Railway PaaS, existing Dockerfiles, Prisma CLI, pnpm
**Storage**: PostgreSQL 16 (Railway managed), Redis 7 (Railway managed)
**Testing**: Manual deployment verification (health endpoints, Mini App load)
**Target Platform**: Railway PaaS (Linux containers)
**Project Type**: Turborepo monorepo (existing)
**Performance Goals**: Deployments complete within 10 minutes; zero-downtime deploys
**Constraints**: No secrets in build logs; Railway's `PORT` env var injection; preDeployCommand for migrations
**Scale/Scope**: 2 app services + 2 managed databases; single environment

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. TypeScript Strict Mode & Code Quality | PASS | No new TypeScript code; config files only |
| II. Vitest Testing Standards | PASS | No new test-requiring source files; Dockerfile changes validated by build + health check |
| III. Observability & Logging | PASS | Existing pino logging unchanged; Railway captures stdout |
| IV. Performance Requirements | PASS | Startup < 10s constraint met by existing services |
| V. Technology Stack & Monorepo | PASS | No new dependencies; Railway is deployment platform, not app dependency |
| VI. Docker-First Deployment | PASS | Directly supports this principle — multi-stage Dockerfiles, env-only config, health checks |
| VII. Data Architecture | PASS | No schema changes |

**Quality Gates**:
- `turbo run build` must pass (Dockerfile changes must produce working images)
- Dockerfile changes validated by building the image and verifying health check responds
- No new source files → no test coverage impact

## Project Structure

### Documentation (this feature)

```text
specs/018-railway-deployment/
├── plan.md              # This file
├── research.md          # Railway configuration research
├── quickstart.md        # Step-by-step Railway setup guide
├── spec.md              # Feature specification
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Task list (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
apps/
├── api/
│   ├── Dockerfile           # MODIFIED: copy prisma/ dir to runner stage
│   └── railway.toml         # NEW: Railway config-as-code for API
├── worker/
│   ├── Dockerfile           # REVIEWED: verify port handling
│   └── railway.toml         # NEW: Railway config-as-code for Worker
└── mini-app/
    └── (no changes — served by API)

docs/
└── RAILWAY.md               # NEW: Railway deployment documentation
```

**Structure Decision**: Existing Turborepo monorepo structure is unchanged. Railway config files (`railway.toml`) are co-located with each service's Dockerfile. No separate Mini App service on Railway — the API serves it at `/app`.

## Architecture

### Railway Project Topology

```text
Railway Project: tg-channels-forwarder
├── api (web service)
│   ├── Source: apps/api/Dockerfile
│   ├── Config: /apps/api/railway.toml
│   ├── Public domain: *.up.railway.app
│   ├── Health: /health
│   └── Pre-deploy: prisma migrate deploy
├── worker (background service)
│   ├── Source: apps/worker/Dockerfile
│   ├── Config: /apps/worker/railway.toml
│   ├── No public domain (internal only)
│   └── Health: /
├── Postgres (managed database)
│   ├── Version: 16
│   └── Provides: DATABASE_URL
└── Redis (managed database)
    ├── Version: 7
    └── Provides: REDIS_URL
```

### Environment Variable Flow

```text
Railway Shared Variables:
  BOT_TOKEN, JWT_SECRET, NODE_ENV
  TELEGRAM_API_ID, TELEGRAM_API_HASH, TELEGRAM_SESSION
    ↓
    ├── api service
    │   ├── PORT=3000
    │   ├── DATABASE_URL=${{Postgres.DATABASE_URL}}
    │   └── REDIS_URL=${{Redis.REDIS_URL}}
    │
    └── worker service
        ├── PORT=3001
        ├── WORKER_HEALTH_PORT=3001
        ├── DATABASE_URL=${{Postgres.DATABASE_URL}}
        └── REDIS_URL=${{Redis.REDIS_URL}}
```

### Deployment Flow

```text
git push main
    ↓
Railway detects push → matches watchPatterns per service
    ↓
┌─────────────────────┐    ┌─────────────────────┐
│ API Build            │    │ Worker Build         │
│ (apps/api/Dockerfile)│    │ (apps/worker/Dockerfile)
│ turbo prune + build  │    │ turbo prune + build  │
└─────────┬───────────┘    └─────────┬───────────┘
          ↓                          ↓
  preDeployCommand:          (no pre-deploy)
  prisma migrate deploy
          ↓                          ↓
  Start: node main.js       Start: node main.js
          ↓                          ↓
  Health: GET /health        Health: GET /
          ↓                          ↓
  ✓ Route traffic            ✓ Mark healthy
```

## Files to Create/Modify

### New Files

| File | Purpose |
|------|---------|
| `apps/api/railway.toml` | Railway config for API: Dockerfile path, watch patterns, health check, pre-deploy migration |
| `apps/worker/railway.toml` | Railway config for Worker: Dockerfile path, watch patterns, health check |
| `docs/RAILWAY.md` | Deployment documentation with setup steps, variable reference, troubleshooting |

### Modified Files

| File | Change |
|------|--------|
| `apps/api/Dockerfile` | Add `COPY` for `prisma/` directory into runner stage; ensure prisma CLI available |
| `apps/api/package.json` | Move `prisma` from devDependencies to dependencies (required for preDeployCommand) |

### Unchanged Files

| File | Reason |
|------|--------|
| `apps/worker/Dockerfile` | Already handles `WORKER_HEALTH_PORT` via env var; no changes needed |
| `apps/mini-app/Dockerfile` | Not deployed as separate Railway service |
| `docker-compose.yml` | Local development only; unchanged |

## Key Decisions

| Decision | Rationale |
|----------|-----------|
| No separate Mini App service | API already bundles and serves mini-app at `/app`; saves a Railway service |
| `preDeployCommand` for migrations | Runs after build, before start; has env var access; Railway-recommended approach |
| Per-service `railway.toml` | Config-as-code; co-located with Dockerfile; reproducible deploys |
| Shared variables for secrets | Set once, referenced by both services; easier to rotate |
| `PORT=3001` for worker | Matches existing `WORKER_HEALTH_PORT`; Railway health check probes this port |
| Watch patterns include `packages/shared/**` | Both services depend on `@aggregator/shared`; changes must trigger rebuild |

## Complexity Tracking

No constitution violations. No complexity justifications needed.
