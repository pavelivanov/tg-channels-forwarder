# Implementation Plan: BullMQ Queue Setup

**Branch**: `007-bullmq-queue-setup` | **Date**: 2026-02-17 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/007-bullmq-queue-setup/spec.md`

## Summary

Set up BullMQ-based message queue infrastructure in the worker app with a producer service, consumer service, dead letter queue, health check extension, and optional bull-board dashboard. Define the `ForwardJob` interface and queue constants in the shared package.

## Technical Context

**Language/Version**: TypeScript 5.x with `strict: true`, Node.js 20 LTS
**Primary Dependencies**: BullMQ (queue/worker), ioredis (Redis client, already installed), express (dashboard mounting), @bull-board/api + @bull-board/express (dashboard UI)
**Storage**: Redis 7 (already provisioned via Docker Compose)
**Testing**: Vitest with real Redis integration tests
**Target Platform**: Linux server (Docker)
**Project Type**: Turborepo monorepo — `apps/worker` (primary), `packages/shared` (types/constants)
**Performance Goals**: ≥100 jobs/sec throughput, <5s job pickup latency
**Constraints**: Worker app is plain TypeScript (not NestJS), uses pino for logging

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| # | Principle | Status | Notes |
|---|-----------|--------|-------|
| I | TypeScript Strict Mode & Code Quality | PASS | All new code in strict TS, single-responsibility services, clean exports via index.ts |
| II | Vitest Testing Standards | PASS | Integration tests for producer/consumer/DLQ/health with real Redis |
| III | Observability & Logging | PASS | pino structured logging throughout, error/warn/info/debug levels per contract |
| IV | Performance Requirements | PASS | BullMQ handles 100+ msg/min, configurable TTL and max retry, retention limits |
| V | Technology Stack & Monorepo | PASS | BullMQ on Redis per constitution ("Redis for ... BullMQ for job queues"), Turborepo managed |
| VI | Docker-First Deployment | PASS | Redis in docker-compose, env vars for config, health endpoint exposed |
| VII | Data Architecture | PASS | Redis for BullMQ job queue state only, all keys have TTL via removeOnComplete/removeOnFail, no message persistence in PostgreSQL |

**Result**: 7/7 PASS — no violations.

## Project Structure

### Documentation (this feature)

```text
specs/007-bullmq-queue-setup/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
│   └── queue-services.md
└── tasks.md              # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
packages/shared/
├── src/
│   ├── queue/
│   │   └── index.ts          # ForwardJob interface + queue constants
│   └── index.ts              # Re-export queue module
└── test/
    └── queue.spec.ts          # ForwardJob type validation tests

apps/worker/
├── src/
│   ├── queue/
│   │   ├── queue-producer.ts  # QueueProducer class
│   │   └── queue-consumer.ts  # QueueConsumer class with DLQ logic
│   ├── dashboard.ts           # Bull Board setup (optional, dev-only)
│   ├── health.ts              # Extended with queue stats
│   ├── config.ts              # Existing (no changes needed)
│   └── main.ts               # Bootstrap: queues, consumer, health
└── test/
    └── queue.spec.ts          # Integration tests: enqueue, consume, retry, DLQ, health
```

**Structure Decision**: All queue infrastructure lives in `apps/worker/src/queue/`. The shared package provides the `ForwardJob` type and queue constants. The API app is NOT modified — queue stats are served by the worker health endpoint, not the NestJS health controller.
