# Implementation Plan: Forwarder Service

**Branch**: `009-forwarder-service` | **Date**: 2026-02-17 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/009-forwarder-service/spec.md`

## Summary

Implement a ForwarderService that consumes `ForwardJob` messages from the BullMQ `message-forward` queue, routes them to destination channels via active subscription lists, deduplicates using the existing Redis-backed DedupService, and sends via the grammY Telegram Bot API. Rate limiting is enforced at two tiers (20 msg/s global, 15 msg/min per-destination) using bottleneck. The existing QueueConsumer stub is replaced with real forwarding logic.

## Technical Context

**Language/Version**: TypeScript 5.x with `strict: true`, Node.js 20 LTS
**Primary Dependencies**: `grammy` (Telegram Bot API), `@grammyjs/auto-retry` (429 handling), `bottleneck` (rate limiting), BullMQ (existing), Prisma (existing), ioredis (existing), pino (existing)
**Storage**: PostgreSQL 16 via Prisma (existing schema, no migrations), Redis (existing, for dedup + BullMQ)
**Testing**: Vitest
**Target Platform**: Linux server (Docker container)
**Project Type**: Turborepo monorepo — changes in `apps/worker` and `packages/shared`
**Performance Goals**: 20 msg/s throughput, <10s end-to-end latency under normal load
**Constraints**: Telegram Bot API limits (30 msg/s global, 20 msg/min per chat), must not trigger 429 bans
**Scale/Scope**: Single worker process, ~100 msg/min expected initial load

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. TypeScript Strict Mode | PASS | All new code in strict TS, `any` only for grammY API result types wrapped behind typed interface |
| II. Vitest Testing Standards | PASS | Tests for ForwarderService, MessageSender, RateLimiterService + integration with QueueConsumer |
| III. Observability & Logging | PASS | pino structured logging: `message_forwarded`, `message_deduplicated`, `forward_failed` with context |
| IV. Performance Requirements | PASS | <5s latency target met by design, bottleneck ensures throughput within limits |
| V. Technology Stack & Monorepo | PASS | grammY (mandated), bottleneck (well-established, 3M weekly downloads), Turborepo structure |
| VI. Docker-First Deployment | PASS | BOT_TOKEN via env var, no config files, health check already exists |
| VII. Data Architecture | PASS | No message persistence, Redis for dedup keys only (with TTL), Prisma for routing |

**Post-design re-check**: All gates pass. No violations.

## Project Structure

### Documentation (this feature)

```text
specs/009-forwarder-service/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
│   ├── forwarder-service.md
│   ├── message-sender.md
│   └── rate-limiter.md
└── tasks.md              # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
apps/worker/
├── src/
│   ├── forwarder/
│   │   ├── forwarder.service.ts    # Core routing + dedup + send orchestration
│   │   ├── message-sender.ts       # grammY API wrapper for all message types
│   │   └── rate-limiter.service.ts # bottleneck dual-tier rate limiter
│   ├── queue/
│   │   └── queue-consumer.ts       # Modified: inject ForwarderService into handler
│   ├── config.ts                   # Modified: add BOT_TOKEN env var
│   └── main.ts                     # Modified: wire ForwarderService, grammY Api, RateLimiter
├── test/
│   ├── forwarder.spec.ts           # ForwarderService unit tests
│   ├── message-sender.spec.ts      # MessageSender unit tests
│   └── rate-limiter.spec.ts        # RateLimiterService unit tests
└── package.json                    # Modified: add grammy, @grammyjs/auto-retry, bottleneck

packages/shared/
└── src/
    └── constants/
        └── index.ts                # Modified: add FORWARD_GLOBAL_RATE_LIMIT, FORWARD_PER_DEST_RATE_LIMIT
```

**Structure Decision**: All new code lives in `apps/worker/src/forwarder/` as a new module. The existing `queue/queue-consumer.ts` is modified to delegate to ForwarderService. No new apps or packages — this is a feature addition to the existing worker.
